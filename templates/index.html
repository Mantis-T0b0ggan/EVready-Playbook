<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EVReady Utility Bill Estimator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
    }
    nav {
      background-color: #1B2A49;
      padding: 10px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    nav a {
      color: white;
      text-decoration: none;
      margin-right: 20px;
      font-weight: bold;
    }
    nav a.active {
      text-decoration: underline;
    }
    h1 {
      color: #1B2A49;
      margin-top: 20px;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    select, input {
      padding: 8px;
      width: 300px;
      margin-bottom: 10px;
    }
    button {
      margin-top: 10px;
      padding: 8px 12px;
      background-color: #1B2A49;
      color: white;
      border: none;
      cursor: pointer;
    }
    #resetBtn {
      background-color: #e60000;
      margin-left: 10px;
    }
    .hidden {
      display: none;
    }
    .result {
      margin-top: 20px;
      background-color: #f2f2f2;
      padding: 20px;
      border-radius: 8px;
    }
    ul {
      list-style-type: none;
      padding-left: 0;
    }
    ul li {
      margin-bottom: 8px;
    }
  </style>
</head>

<body>

<nav>
  <a href="/" class="active">Bill Estimator</a>
  <a href="/browse_schedules">Schedule Browser</a>
</nav>

<h1>EVReady Utility Bill Estimator</h1>

<label for="state">Select a State:</label>
<select id="state"></select>

<label for="utility">Select a Utility:</label>
<select id="utility"></select>

<label for="schedule">Select a Schedule:</label>
<select id="schedule"></select>

<div id="input-fields">
  <div id="kwh-section" class="hidden">
    <label for="kwh">Monthly kWh Usage:</label>
    <input type="number" id="kwh">
  </div>

  <div id="kw-section" class="hidden">
    <label for="kw">Monthly kW Demand:</label>
    <input type="number" id="kw">
  </div>

  <div id="days-section" class="hidden">
    <label for="days">Billing Days:</label>
    <input type="number" id="days">
  </div>
</div>

<button id="submitBtn">Estimate Bill</button>
<button id="resetBtn">ðŸ”„ Reset Selection</button>

<div class="result" id="resultBox"></div>

<script>
  async function fetchStates() {
    const res = await fetch('/states');
    const states = await res.json();
    const select = document.getElementById('state');
    select.innerHTML = '<option value="">-- Select a State --</option>';
    states.forEach(state => {
      select.innerHTML += `<option value="${state}">${state}</option>`;
    });
  }

  async function fetchUtilities(state) {
    const res = await fetch(`/get_utilities_by_state?state=${state}`);
    const data = await res.json();
    const select = document.getElementById('utility');
    select.innerHTML = '<option value="">-- Select a Utility --</option>';
    data.forEach(util => {
      select.innerHTML += `<option value="${util.UtilityID}">${util.UtilityName}</option>`;
    });
  }

  async function fetchSchedules(utilityID) {
  const res = await fetch(`/schedules?utility_id=${utilityID}`);
  const data = await res.json();
  const select = document.getElementById('schedule');
  select.innerHTML = '<option value="">-- Select a Schedule --</option>';
  
  data.forEach(sch => {
    let label = "";
    if (sch.ScheduleName && sch.ScheduleName.trim() !== "") {
      label = sch.ScheduleName;
    } else if (sch.ScheduleDescription && sch.ScheduleDescription.trim() !== "") {
      label = sch.ScheduleDescription;
    }

    if (label !== "") {
      select.innerHTML += `<option value="${sch.ScheduleID}">${label}</option>`;
    }
  });
}

  async function fetchScheduleDetails(scheduleID) {
    const res = await fetch(`/schedule_details?schedule_id=${scheduleID}`);
    const data = await res.json();
    const tables = data.present_tables || [];

    document.getElementById('kwh-section').classList.toggle('hidden', !tables.includes("EnergyTime_Table") && !tables.includes("Energy_Table"));
    document.getElementById('kw-section').classList.toggle('hidden', !tables.includes("DemandTime_Table") && !tables.includes("Demand_Table"));
    document.getElementById('days-section').classList.toggle('hidden', !tables.includes("ServiceCharge_Table"));
  }

  document.getElementById('state').addEventListener('change', e => {
    const state = e.target.value;
    fetchUtilities(state);
    document.getElementById('utility').innerHTML = '';
    document.getElementById('schedule').innerHTML = '';
    document.getElementById('resultBox').innerHTML = '';
    document.getElementById('input-fields').classList.add('hidden');
  });

  document.getElementById('utility').addEventListener('change', e => {
    const utilityID = e.target.value;
    fetchSchedules(utilityID);
  });

  document.getElementById('schedule').addEventListener('change', e => {
    const scheduleID = e.target.value;
    fetchScheduleDetails(scheduleID);
    document.getElementById('input-fields').classList.remove('hidden');
  });

  document.getElementById('submitBtn').addEventListener('click', async () => {
    const state = document.getElementById('state').value;
    const utility = document.getElementById('utility').value;
    const schedule = document.getElementById('schedule').value;
    const kwh = document.getElementById('kwh').value;
    const kw = document.getElementById('kw').value;
    const days = document.getElementById('days').value;

    const resultBox = document.getElementById('resultBox');

    if (!state || !utility || !schedule) {
      resultBox.innerHTML = `<em>Please complete all selections before estimating the bill.</em>`;
      return;
    }

    const payload = {
      schedule_id: schedule,
      kwh: kwh || 0,
      kw: kw || 0,
      days: days || 0
    };

    const res = await fetch('/calculate_bill', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    const result = await res.json();

    if (res.ok) {
      let breakdownHtml = "";
      for (const [table, amount] of Object.entries(result.breakdown)) {
        breakdownHtml += `<li><strong>${table.replace("_", " ").replace("Table", "").replace("TIP", "").trim()}:</strong> $${amount.toFixed(2)}</li>`;
      }

      resultBox.innerHTML = `
        <strong>State:</strong> ${state}<br>
        <strong>Utility ID:</strong> ${utility}<br>
        <strong>Schedule ID:</strong> ${schedule}<br>
        <strong>Usage:</strong> ${kwh || "n/a"} kWh<br>
        <strong>Demand:</strong> ${kw || "n/a"} kW<br>
        <strong>Days:</strong> ${days || "n/a"} days<br><br>
        <strong>Total Estimated Cost:</strong> $${result.total_cost.toFixed(2)}<br><br>

        <ul>${breakdownHtml}</ul>
      `;
    } else {
      resultBox.innerHTML = `<em>Error calculating bill: ${result.error}</em>`;
    }
  });

  document.getElementById('resetBtn').addEventListener('click', () => {
    document.getElementById('state').selectedIndex = 0;
    document.getElementById('utility').innerHTML = '';
    document.getElementById('schedule').innerHTML = '';
    document.getElementById('kwh').value = '';
    document.getElementById('kw').value = '';
    document.getElementById('days').value = '';
    document.getElementById('input-fields').classList.add('hidden');
    document.getElementById('resultBox').innerHTML = '';
    fetchStates();
  });

  fetchStates();
</script>

</body>
</html>

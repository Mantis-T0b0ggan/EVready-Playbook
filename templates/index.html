<!DOCTYPE html>
<html>
<head>
  <title>EVready Utility Schedule Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background-color: #f5f5f5;
    }
    select, button {
      font-size: 16px;
      padding: 8px;
      margin: 10px 0;
    }
    label {
      font-weight: bold;
    }
    #scheduleOutput {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border: 1px solid #ccc;
    }
    .dropdown-group {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>Utility Schedule Viewer</h1>

  <div class="dropdown-group">
    <label for="state">Select State:</label><br>
    <select id="stateDropdown">
      <option value="">-- Choose a state --</option>
    </select>
  </div>

  <div class="dropdown-group">
    <label for="utility">Select Utility:</label><br>
    <select id="utilityDropdown" disabled>
      <option value="">-- Choose a utility --</option>
    </select>
  </div>

  <div class="dropdown-group">
    <label for="schedule">Select Schedule:</label><br>
    <select id="scheduleDropdown" disabled>
      <option value="">-- Choose a schedule --</option>
    </select>
  </div>

  <button id="viewBtn" disabled>View Schedule Details</button>

  <div id="scheduleOutput"></div>

  <script>
    const stateDropdown = document.getElementById('stateDropdown');
    const utilityDropdown = document.getElementById('utilityDropdown');
    const scheduleDropdown = document.getElementById('scheduleDropdown');
    const viewBtn = document.getElementById('viewBtn');
    const output = document.getElementById('scheduleOutput');

    // Load states
    fetch("/states")
      .then(res => res.json())
      .then(states => {
        states.forEach(state => {
          const option = document.createElement('option');
          option.value = state;
          option.textContent = state;
          stateDropdown.appendChild(option);
        });
      });

    // When state changes, get utilities
    stateDropdown.addEventListener("change", () => {
      const state = stateDropdown.value;
      utilityDropdown.innerHTML = '<option value="">-- Choose a utility --</option>';
      scheduleDropdown.innerHTML = '<option value="">-- Choose a schedule --</option>';
      utilityDropdown.disabled = true;
      scheduleDropdown.disabled = true;
      viewBtn.disabled = true;
      output.innerHTML = "";

      if (!state) return;

      fetch(`/utilities_by_state?state=${state}`)
        .then(res => res.json())
        .then(data => {
          data.forEach(util => {
            const opt = document.createElement('option');
            opt.value = util.UtilityID;
            opt.textContent = util.UtilityName;
            utilityDropdown.appendChild(opt);
          });
          utilityDropdown.disabled = false;
        });
    });

    // When utility changes, get schedules
    utilityDropdown.addEventListener("change", () => {
      const utility_id = utilityDropdown.value;
      scheduleDropdown.innerHTML = '<option value="">-- Choose a schedule --</option>';
      scheduleDropdown.disabled = true;
      viewBtn.disabled = true;
      output.innerHTML = "";

      if (!utility_id) return;

      fetch(`/schedules_by_utility?utility_id=${utility_id}`)
        .then(res => res.json())
        .then(data => {
          data.forEach(sch => {
            const opt = document.createElement('option');
            opt.value = sch.ScheduleID;
            opt.textContent = sch.ScheduleName + " (ID: " + sch.ScheduleID + ")";
            scheduleDropdown.appendChild(opt);
          });
          scheduleDropdown.disabled = false;
        });
    });

    // Enable button when schedule selected
    scheduleDropdown.addEventListener("change", () => {
      viewBtn.disabled = !scheduleDropdown.value;
      output.innerHTML = "";
    });

    // View schedule details
    viewBtn.addEventListener("click", () => {
      const schedule_id = scheduleDropdown.value;
      output.innerHTML = "Loading...";

      fetch(`/view_schedule?schedule_id=${schedule_id}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            output.innerHTML = `<p style="color:red;">${data.error}</p>`;
            return;
          }

          let html = `<h2>Schedule ID: ${data.ScheduleID}</h2>`;
          html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
          output.innerHTML = html;
        })
        .catch(err => {
          output.innerHTML = `<p style="color:red;">Error loading schedule.</p>`;
        });
    });
  </script>
</body>
</html>

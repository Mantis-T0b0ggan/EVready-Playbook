<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EVReady Utility Bill Estimator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
    }
    h1 {
      color: #1B2A49;
    }
    label {
      display: block;
      margin-top: 15px;
    }
    select, input {
      padding: 8px;
      width: 300px;
    }
    button {
      margin-top: 20px;
      padding: 10px 15px;
      background-color: #1B2A49;
      color: white;
      border: none;
      cursor: pointer;
    }
    .hidden {
      display: none;
    }
    .result {
      margin-top: 20px;
      background-color: #f2f2f2;
      padding: 15px;
      line-height: 1.5;
    }
    ul {
      margin-top: 10px;
      padding-left: 20px;
    }
  </style>
</head>
<body>

<h1>EVReady Utility Bill Estimator</h1>

<label for="state">Select a State:</label>
<select id="state"></select>

<label for="utility">Select a Utility:</label>
<select id="utility"></select>

<label for="schedule">Select a Schedule:</label>
<select id="schedule"></select>

<div id="input-fields">
  <div id="kwh-section" class="hidden">
    <label for="kwh">Monthly kWh Usage:</label>
    <input type="number" id="kwh">
  </div>

  <div id="kw-section">
    <label for="kw">Monthly kW Demand:</label>
    <input type="number" id="kw">
  </div>

  <div id="days-section" class="hidden">
    <label for="days">Billing Days:</label>
    <input type="number" id="days">
  </div>
</div>

<button id="submitBtn">Estimate Bill</button>

<div class="result" id="resultBox"></div>

<script>
  async function fetchStates() {
    const res = await fetch('/states');
    const states = await res.json();
    const select = document.getElementById('state');
    select.innerHTML = '<option value="">-- Select --</option>';
    states.forEach(state => {
      select.innerHTML += `<option value="${state}">${state}</option>`;
    });
  }

  async function fetchUtilities(state) {
    const res = await fetch(`/utilities?state=${state}`);
    const data = await res.json();
    const select = document.getElementById('utility');
    select.innerHTML = '<option value="">-- Select --</option>';
    data.forEach(util => {
      select.innerHTML += `<option value="${util.UtilityID}">${util.UtilityName}</option>`;
    });
  }

  async function fetchSchedules(utilityID) {
    const res = await fetch(`/schedules?utility_id=${utilityID}`);
    const data = await res.json();
    const select = document.getElementById('schedule');
    select.innerHTML = '<option value="">-- Select --</option>';
    data.forEach(sch => {
      select.innerHTML += `<option value="${sch.ScheduleID}">${sch.ScheduleName}</option>`;
    });
  }

  async function fetchScheduleDetails(scheduleID) {
    const res = await fetch(`/schedule_details?schedule_id=${scheduleID}`);
    const data = await res.json();
    console.log("Schedule detail response:", data);

    const tables = data.present_tables || [];

    document.getElementById('kwh-section').classList.toggle('hidden', !tables.includes("EnergyTime_Table"));
    document.getElementById('days-section').classList.toggle('hidden', !tables.includes("ServiceCharge_Table"));

    // Always show kW input for now
    document.getElementById('kw-section').classList.remove('hidden');
  }

  document.getElementById('state').addEventListener('change', e => {
    const state = e.target.value;
    fetchUtilities(state);
    document.getElementById('utility').innerHTML = '';
    document.getElementById('schedule').innerHTML = '';
    document.getElementById('resultBox').innerHTML = '';
  });

  document.getElementById('utility').addEventListener('change', e => {
    const utilityID = e.target.value;
    fetchSchedules(utilityID);
    document.getElementById('resultBox').innerHTML = '';
  });

  document.getElementById('schedule').addEventListener('change', e => {
    const scheduleID = e.target.value;
    fetchScheduleDetails(scheduleID);
    document.getElementById('resultBox').innerHTML = '';
  });

  document.getElementById('submitBtn').addEventListener('click', async () => {
    const state = document.getElementById('state').value;
    const utility = document.getElementById('utility').value;
    const schedule = document.getElementById('schedule').value;
    const kwh = document.getElementById('kwh').value || 0;
    const kw = document.getElementById('kw').value || 0;
    const days = document.getElementById('days').value || 30;

    const resultBox = document.getElementById('resultBox');
    resultBox.innerHTML = "‚è≥ Calculating...";

    try {
      const res = await fetch('/calculate_bill', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          schedule_id: schedule,
          usage_kwh: kwh,
          demand_kw: kw,
          billing_days: days
        })
      });

      const data = await res.json();

      if (data.error) {
        resultBox.innerHTML = `<strong>Error:</strong> ${data.error}`;
      } else {
        let breakdownHtml = "";
        for (const [label, value] of Object.entries(data.breakdown)) {
          breakdownHtml += `<li>${label}: $${value.toFixed(2)}</li>`;
        }

        resultBox.innerHTML = `
          <strong>State:</strong> ${state}<br>
          <strong>Utility ID:</strong> ${utility}<br>
          <strong>Schedule ID:</strong> ${schedule}<br>
          <strong>Usage:</strong> ${kwh} kWh<br>
          <strong>Demand:</strong> ${kw} kW<br>
          <strong>Days:</strong> ${days} days<br><br>
          <strong>Total Estimated Cost:</strong> $${data.total_cost.toFixed(2)}<br>
          <ul>${breakdownHtml}</ul>
        `;
      }

    } catch (err) {
      console.error(err);
      resultBox.innerHTML = `<strong>Request failed:</strong> ${err.message}`;
    }
  });

  fetchStates();
</script>

</body>
</html>

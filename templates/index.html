<!DOCTYPE html>
<html>
<head>
  <title>EVReady Utility Bill Estimator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }
    h1 {
      color: #1c2b4a;
    }
    label {
      display: block;
      margin-top: 20px;
    }
    select, input {
      padding: 6px;
      margin-top: 5px;
      width: 300px;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #1c2b4a;
      color: white;
      border: none;
      cursor: pointer;
    }
    #result {
      margin-top: 30px;
      padding: 15px;
      background: #f2f2f2;
      width: 500px;
    }
  </style>
</head>
<body>
  <h1>EVReady Utility Bill Estimator</h1>

  <label>Select a State:</label>
  <select id="stateDropdown"></select>

  <label>Select a Utility:</label>
  <select id="utilityDropdown"></select>

  <label>Select a Schedule:</label>
  <select id="scheduleDropdown"></select>

  <label>Monthly kWh Usage:</label>
  <input type="number" id="kwhUsage" placeholder="e.g. 1200">

  <label>Monthly kW Demand:</label>
  <input type="number" id="kwDemand" placeholder="e.g. 50">

  <label>Billing Days:</label>
  <input type="number" id="billingDays" placeholder="e.g. 30">

  <button onclick="calculateBill()">Estimate Bill</button>

  <div id="result"></div>

  <script>
    async function fetchStates() {
      const res = await fetch("/states");
      const states = await res.json();
      const dropdown = document.getElementById("stateDropdown");
      dropdown.innerHTML = `<option value="">Select state</option>`;
      states.forEach(state => {
        dropdown.innerHTML += `<option value="${state}">${state}</option>`;
      });
    }

    async function fetchUtilities() {
      const state = document.getElementById("stateDropdown").value;
      const res = await fetch(`/utilities?state=${state}`);
      const utilities = await res.json();
      const dropdown = document.getElementById("utilityDropdown");
      dropdown.innerHTML = `<option value="">Select utility</option>`;
      utilities.forEach(util => {
        dropdown.innerHTML += `<option value="${util.UtilityID}">${util.UtilityName}</option>`;
      });
    }

    async function fetchSchedules() {
      const utilityID = document.getElementById("utilityDropdown").value;
      const res = await fetch(`/schedules?utility_id=${utilityID}`);
      const schedules = await res.json();
      const dropdown = document.getElementById("scheduleDropdown");
      dropdown.innerHTML = `<option value="">Select schedule</option>`;
      schedules.forEach(sch => {
        dropdown.innerHTML += `<option value="${sch.ScheduleID}">${sch.ScheduleName}</option>`;
      });
    }

    async function calculateBill() {
      const scheduleID = document.getElementById("scheduleDropdown").value;
      const kwh = parseFloat(document.getElementById("kwhUsage").value);
      const kw = parseFloat(document.getElementById("kwDemand").value);
      const days = parseInt(document.getElementById("billingDays").value);

      if (!scheduleID || isNaN(kwh) || isNaN(kw) || isNaN(days)) {
        document.getElementById("result").innerText = "Please fill in all fields.";
        return;
      }

      const res = await fetch(`/calculate_bill?schedule_id=${scheduleID}&kwh=${kwh}&kw=${kw}&days=${days}`);
      const data = await res.json();

      if (data.error) {
        document.getElementById("result").innerText = "Error: " + data.error;
      } else {
        document.getElementById("result").innerHTML = `
          <strong>Estimated Monthly Bill:</strong> $${data.total.toFixed(2)}<br>
          Breakdown:<br>
          Energy: $${data.energy.toFixed(2)}<br>
          Demand: $${data.demand.toFixed(2)}<br>
          Fixed Charges: $${data.fixed.toFixed(2)}<br>
        `;
      }
    }

    document.getElementById("stateDropdown").addEventListener("change", fetchUtilities);
    document.getElementById("utilityDropdown").addEventListener("change", fetchSchedules);

    fetchStates();
  </script>
</body>
</html>
